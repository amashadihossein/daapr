<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="daapr">
<title>Combine two data products • daapr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combine two data products">
<meta property="og:description" content="daapr">
<meta property="og:image" content="https://amashadihossein.github.io/daapr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">daapr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9005</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/daapr.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/min_wrkfl.html">A minimalist example</a>
    <a class="dropdown-item" href="../articles/input_data_update.html">Update input data</a>
    <a class="dropdown-item" href="../articles/dp_update.html">Update build logic</a>
    <a class="dropdown-item" href="../articles/dp_merge.html">Combine two data products</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/amashadihossein/daapr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Combine two data products</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/amashadihossein/daapr/blob/HEAD/vignettes/dp_merge.Rmd" class="external-link"><code>vignettes/dp_merge.Rmd</code></a></small>
      <div class="d-none name"><code>dp_merge.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="goal">Goal<a class="anchor" aria-label="anchor" href="#goal"></a>
</h2>
<p>Combine two data products to demonstrate the workflow</p>
</div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>A data product with a broader scope may encompass one or more other
data products. In such cases, data products can be directly imported
within the data processing logic and they are not considered
<code>input_data</code>.</p>
</div>
<div class="section level2">
<h2 id="user-story">User Story<a class="anchor" aria-label="anchor" href="#user-story"></a>
</h2>
<p>We need to have information we derived and encoded previously within
<code>dp_cars-us001</code> and information within
<code>dp_mtcars-us001</code> (which is simply a toy data product based
on <code>mtcars</code> dataset we have built).</p>
</div>
<div class="section level2">
<h2 id="step-1-initialize-the-project">Step 1: Initialize the project<a class="anchor" aria-label="anchor" href="#step-1-initialize-the-project"></a>
</h2>
<p>As this is a new project, we initialize the project using
<code><a href="https://rdrr.io/pkg/dpbuild/man/dp_init.html" class="external-link">dpbuild::dp_init</a></code>. See the vignette on new project workflow
for details of what the initialization does.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">daapr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">board_params_set_dried</span>  <span class="op">&lt;-</span> <span class="fu">fn_dry</span><span class="op">(</span><span class="fu">board_params_set_s3</span><span class="op">(</span>board_alias <span class="op">=</span> <span class="st">"&lt;ALIAS&gt;"</span>,</span>
<span>                                                      bucket_name <span class="op">=</span> <span class="st">"&lt;BUCKET&gt;"</span>,</span>
<span>                                                      region <span class="op">=</span> <span class="st">"&lt;REIGION&gt;"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Dry function call to setting credentials</span></span>
<span><span class="va">creds_set_dried</span> <span class="op">&lt;-</span> <span class="fu">fn_dry</span><span class="op">(</span><span class="fu">creds_set_aws</span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"AWS_KEY"</span><span class="op">)</span>,</span>
<span>                                        secret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"AWS_SECRET"</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize dp repo</span></span>
<span><span class="va">dp_repo</span> <span class="op">&lt;-</span> <span class="fu">dp_init</span><span class="op">(</span>project_path <span class="op">=</span> <span class="st">"dp_xcars"</span>,</span>
<span>                   project_description <span class="op">=</span> <span class="st">"Cars and mtcars combined data product"</span>,</span>
<span>                   branch_name <span class="op">=</span> <span class="st">"us001"</span>,</span>
<span>                   branch_description <span class="op">=</span> <span class="st">"User story 1"</span>,</span>
<span>                   readme_general_note <span class="op">=</span> <span class="st">"Data product combining cars and metcars"</span>,</span>
<span>                   board_params_set_dried <span class="op">=</span> <span class="va">board_params_set_dried</span>,</span>
<span>                   creds_set_dried <span class="op">=</span> <span class="va">creds_set_dried</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-set-up-the-working-environment">Step 2: Set up the working environment<a class="anchor" aria-label="anchor" href="#step-2-set-up-the-working-environment"></a>
</h2>
<p>At this point your project has all the basic components to provide
you with a sandbox where you can do your development. It is not
necessary, but it may be instructional to clean and restart your R
session before this next step. Then, activate and set up the sandbox for
this project.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># only necessary if you re-started your R session</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"daapr"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/zpackages.html" class="external-link">.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"daapr"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Activate the repo and switch directory</span></span>
<span><span class="fu">dp_activate</span><span class="op">(</span>project_path <span class="op">=</span> <span class="st">"./dp_xcars/"</span><span class="op">)</span></span>
<span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/restore.html" class="external-link">restore</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up "promised" env variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"AWS_KEY"</span> <span class="op">=</span> <span class="st">"&lt;BUCKETS AWS KEY&gt;"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"AWS_SECRET"</span> <span class="op">=</span> <span class="st">"&lt;BUCKETS AWS SECRET&gt;"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Retrieve configuration</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">dpconf_get</span><span class="op">(</span>project_path <span class="op">=</span> <span class="st">"."</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up remote git env variable so you can directly push your code to git </span></span>
<span><span class="co"># remote. This will only be used when you are pushing the code, but we can set </span></span>
<span><span class="co"># it now as we are setting up our working env. If you don't want to deal with</span></span>
<span><span class="co"># this you can skip this. You can still go quite far in the workflow</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"GITHUB_PAT"</span> <span class="op">=</span> <span class="st">"&lt;YOUR GITHUB PAT&gt;"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-3-build-the-data-product">Step 3: Build the data product<a class="anchor" aria-label="anchor" href="#step-3-build-the-data-product"></a>
</h2>
<p>Here is where the main logic of the data product is implement and the
data product is built. Note, if we had additional data that needed to be
included in the data product, we would mapped and synced it as done when
building <code>dp_cars</code>, prior to build the <code>dp_xcars</code>
logic.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dp_connect</span><span class="op">(</span>board_params <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">board_params</span>, creds <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">creds</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dp_cars</span> <span class="op">&lt;-</span> <span class="fu">dp_get</span><span class="op">(</span>board_params <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">board_params</span>,</span>
<span>                  data_name <span class="op">=</span> <span class="st">"dp-cars-us001"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dp_mtcars</span> <span class="op">&lt;-</span> <span class="fu">dp_get</span><span class="op">(</span>board_params <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">board_params</span>,</span>
<span>                  data_name <span class="op">=</span> <span class="st">"dp-mtcars-us001"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build your output data</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cars <span class="op">=</span> <span class="va">dp_cars</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">cars</span>, mt_cars <span class="op">=</span> <span class="va">dp_mtcars</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Structure the input, output, metadata ... you wish to have in your data product</span></span>
<span><span class="va">data_object</span> <span class="op">&lt;-</span> <span class="fu">dp_structure</span><span class="op">(</span>data_files_read <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                            output <span class="op">=</span> <span class="va">output</span>,config <span class="op">=</span> <span class="va">config</span><span class="op">)</span></span>
<span><span class="co"># save and log the data product built</span></span>
<span><span class="fu">dp_write</span><span class="op">(</span>data_object <span class="op">=</span> <span class="va">data_object</span>, project_path <span class="op">=</span> <span class="st">"."</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-5-commit-and-push">Step 5: Commit and push<a class="anchor" aria-label="anchor" href="#step-5-commit-and-push"></a>
</h2>
<p>At this point, you can commit and push your code. NOTE: for your push
to work</p>
<ol style="list-style-type: decimal">
<li>You should have created the empty repo on the git remote
(e.g. github)</li>
<li>
<code>Sys.getenv("GITHUB_PAT")</code> returns the corresponding
“GITHUB_PAT”</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dp_commit</span><span class="op">(</span>project_path <span class="op">=</span> <span class="st">"."</span>, commit_description <span class="op">=</span> <span class="st">"First dp build"</span><span class="op">)</span></span>
<span><span class="fu">dp_push</span><span class="op">(</span>project_path <span class="op">=</span> <span class="st">"."</span>, remote_url <span class="op">=</span> <span class="st">"&lt;GIT PATH/dp_cars.git&gt;"</span> <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-6-deploy">Step 6: Deploy<a class="anchor" aria-label="anchor" href="#step-6-deploy"></a>
</h2>
<p>The typical deploy should follow a fresh clone from remote git
(e.g. by CI), but here for brevity we can bypass that and manually
deploy.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dp_deploy</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-7-data-access">Step 7: Data access<a class="anchor" aria-label="anchor" href="#step-7-data-access"></a>
</h2>
<p>Typical access pattern starts with setting up the env vars, but for
brevity here we can just use the existing config to connect to the
board, get the data and list what else is on the board.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dp_connect</span><span class="op">(</span>board_params <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">board_params</span>, creds <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">creds</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dp</span> <span class="op">&lt;-</span> <span class="fu">dp_get</span><span class="op">(</span>board_params <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">board_params</span>, data_name <span class="op">=</span> <span class="st">"dp-xcars-us001"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dp_list</span><span class="op">(</span>board_params <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">board_params</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Afshin Mashadi-Hossein.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
